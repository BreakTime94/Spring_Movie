<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/index :: setContent(~{this :: content})}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <th:block th:fragment="content">
    <h1 class="mt-4">Movie Register</h1>
    <form th:action="@{/movie/register}" th:method="post" class="register-form">
      <div class="form-group my-3">
        <label>Title</label>
        <input type="text" class="form-control" name="title" placeholder="Enter Title">
      </div>

      <div class="form-group my-3">
        <label>Image Files</label>
        <input type="file" class="form-control" id="files" multiple>
      </div>

      <ul class="image-list box my-3"></ul>

<!--      <input type="hidden" name="list[0].uuid" value="1234">-->
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
  </th:block>
</th:block>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js" integrity="sha512-h9644v03pHqrIHThkvXhB2PJ8zf5E9IyVnrSfZg8Yj8k4RsO4zldcQc4Bi9iVLUCCsqNY0b4WXVV4UB+wbWENA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  window.onload = _ => {
    document.querySelector(".image-list").addEventListener("click", e => {
      if(e.target.matches(".btn-close")) {
        e.target.closest("li").remove();
      }
    })


    document.querySelector(".register-form").addEventListener("submit", e => {
      e.preventDefault();
      console.log(document.querySelector("input[name=title]").value);
      console.log(e.target);
      document.querySelector(".register-form").innerHTML += [... document.querySelectorAll(".image-list li")].map((el, i) => {
        const obj = {...el.dataset};
        console.log(obj)
        let str = "";
        for(const x in obj) {
          str += `<input type="hidden" name="list[${i}].${x}" value="${obj[x]}">`;
        }
        return str;
      }).join("")
      //e.target.submit();
    })

  }

  document.querySelector("#files").addEventListener('change', (event) => {
    event.preventDefault();
    const formData = new FormData();

    const files = document.querySelector("[type=file]").files;
    [...files].forEach(file => {formData.append("files", file);
    });

    (async () => {
      try {
        const resp = await axios.post('/uploadAjax', formData, {
          headers: {
            "Content-Type": "multipart/form-data"
          }
        });
        document.querySelector(".image-list").innerHTML += resp.data.map(file =>
            `<li data-uuid="${file.uuid}" data-origin="${file.origin}" data-path="${file.path}">
<img src="/display${file.thumb}" alt="${file.origin}"><button class="btn btn-close"></button>
</li>`
        ).join('');
        console.log("업로드 완료")
      } catch (error) {
        console.log(error);
        const status = error.response.status;
        if(status === 400) {
          alert(error.response.data);
        }
        else if (status == 500){
          alert("서버 오류가 발생했습니다.")
        }
        else {
          alert("알수 없는 오류" + status);
        }
      }

    })();
  })


</script>

</html>